<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixy - Authentication</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            max-width: 400px;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .button {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Opening Fixy App...</h2>
        <p>Please wait while we redirect you to the Fixy app.</p>
        <p>If the app doesn't open automatically, click the button below:</p>
        <a href="#" id="openApp" class="button">Open Fixy App</a>
    </div>

    <script>
        // Debug: Log current URL and parameters
        console.log('Current URL:', window.location.href);
        console.log('Search params:', window.location.search);
        console.log('Hash:', window.location.hash);
        
        // Extract URL parameters from both search params and hash
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // Try to get tokens from both locations
        const accessToken = urlParams.get('access_token') || hashParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
        const error = urlParams.get('error') || hashParams.get('error');
        const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
        
        // Debug: Log extracted values
        console.log('Access token:', accessToken);
        console.log('Refresh token:', refreshToken);
        console.log('Error:', error);
        console.log('Error description:', errorDescription);

        if (error) {
            document.querySelector('h2').textContent = 'Authentication Error';
            document.querySelector('p').textContent = errorDescription || error;
            document.querySelector('.spinner').style.display = 'none';
        } else if (accessToken && refreshToken) {
            // Prefer opening the standalone app scheme, then fall back to Expo Go project URL for testing
            const projectId = '68216ec1-e541-4d9d-a51e-733ac2aec1a7';
            const appUrl = `fixy://auth/callback?access_token=${encodeURIComponent(accessToken)}&refresh_token=${encodeURIComponent(refreshToken)}`;
            // Experience-scoped same-tab link for Expo Go (reuses existing Fixy tab)
            const expoGoSameTabUrl = `exp+fixy://u.expo.dev/${projectId}/--/auth/callback?access_token=${encodeURIComponent(accessToken)}&refresh_token=${encodeURIComponent(refreshToken)}`;
            // Project deep link (may open a new tab if Fixy isn't open)
            const expoGoProjectUrl = `exp://u.expo.dev/${projectId}/--/auth/callback?access_token=${encodeURIComponent(accessToken)}&refresh_token=${encodeURIComponent(refreshToken)}`;

            console.log('Attempt app URL:', appUrl);
            console.log('Expo Go same-tab URL:', expoGoSameTabUrl);
            console.log('Expo Go project URL:', expoGoProjectUrl);

            // Try app scheme first (works for standalone builds)
            window.location.href = appUrl;

            // First fallback to Expo Go same-tab (re-uses the existing Fixy tab in Expo Go)
            setTimeout(() => {
                window.location.href = expoGoSameTabUrl;
            }, 600);

            // Final fallback to Expo Go project deep link (may open a new tab)
            setTimeout(() => {
                window.location.href = expoGoProjectUrl;
            }, 1400);

            // Update button to same-tab Expo Go URL so users can tap manually
            document.getElementById('openApp').href = expoGoSameTabUrl;
            
            // Fallback message if neither works after a few seconds
            setTimeout(() => {
                document.querySelector('h2').textContent = 'App Not Found';
                document.querySelector('p').textContent = 'If you are testing with Expo Go, ensure the Fixy project is opened in Expo Go. Otherwise, install the standalone app.';
            }, 3000);
        } else {
            // Show debug information
            document.querySelector('h2').textContent = 'Debug Information';
            document.querySelector('p').innerHTML = `
                <strong>Current URL:</strong> ${window.location.href}<br>
                <strong>Search params:</strong> ${window.location.search}<br>
                <strong>Hash:</strong> ${window.location.hash}<br>
                <strong>Access token found:</strong> ${accessToken ? 'Yes' : 'No'}<br>
                <strong>Refresh token found:</strong> ${refreshToken ? 'Yes' : 'No'}
            `;
            document.querySelector('.spinner').style.display = 'none';
            
            // Still provide a fallback button (Expo Go project deep link)
            const projectId = '68216ec1-e541-4d9d-a51e-733ac2aec1a7';
            document.getElementById('openApp').href = `exp+fixy://u.expo.dev/${projectId}/--/auth/callback`;
        }
    </script>
</body>
</html>
